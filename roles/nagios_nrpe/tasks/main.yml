---

- name: Install NRPE dependencies
  package: 
    name: ['git', 'autoconf', 'gcc', 'libc6', 'libmcrypt-dev', 'make', 'libssl-dev', 'wget']
    state: present
  when: ansible_os_family == "Debian"

- name: Install NRPE dependencies
  package: 
    name: ['git', 'gcc', 'glibc', 'glibc-common', 'openssl', 'openssl-devel', 'perl', 'wget']
    state: present
  when: ansible_os_family == "RedHat"

#--------------------------------------------------
# CREATE NAGIOS USERS
#--------------------------------------------------
- name: Create nagios system group
  group:
    name: nagios
  tags: nagios_install

- name: Create nagios command system group
  group:
    name: nagcmd
  tags: nagios_install

- name: Create nagios system user
  user:
    system: yes
    name: nagios
    group: nagios
    groups: nagcmd
  tags: nagios_install

#--------------------------------------------------
# INSTALLATION NAGIOS NRPE
#--------------------------------------------------
- name: Retrieve and Uncompress Nagios NRPE
  unarchive:
    src: https://github.com/NagiosEnterprises/nrpe/releases/download/nrpe-3.2.1/nrpe-3.2.1.tar.gz
    remote_src: yes
    dest: /root/
    creates: /root/nrpe-3.2.1
  register: nrpe_downloaded

- name: Initial configuration Nagios NRPE
  shell: ./configure --enable-command-args --with-nagios-user=nagios --with-nagios-group=nagios --with-ssl=/usr/bin/openssl --with-ssl-lib=/usr/lib/x86_64-linux-gnu --enable-ssl
  args:
    chdir: /root/nrpe-3.2.1
  async: 500
  poll: 10
  when: nrpe_downloaded.skipped is not defined and nrpe_downloaded.changed

- name: Make nagios NRPE
  make:
    chdir: /root/nrpe-3.2.1
    target: "{{ item }}"
  with_items:
    - all
    - install
    - install-config
    - install-init
  async: 120
  poll: 10
  when: nrpe_downloaded.skipped is not defined and nrpe_downloaded.changed

- name: Systemd daemon reload
  systemd: daemon-reload=yes
  when: nrpe_downloaded.skipped is not defined and nrpe_downloaded.changed

- name: Make NRPE start with system
  service:
    name: nrpe
    state: started
    enabled: true

- name: Check that nrpe is defined in services
  lineinfile:
    name: /etc/services
    regexp: '^nrpe'
    line: "nrpe            5666/tcp                        # Nagios Remote Plugin Executor"

#--------------------------------------------------
# INSTALLATION NAGIOS PLUGINS
#--------------------------------------------------
- name: Retrieve and Uncompress Nagios Plugins
  unarchive:
    src: https://github.com/nagios-plugins/nagios-plugins/releases/download/release-2.2.1/nagios-plugins-2.2.1.tar.gz
    remote_src: yes
    dest: /root/
    creates: /root/nagios-plugins-2.2.1
  register: plugins_downloaded

- name: Initial configuration Nagios Plugins
  shell: ./configure --with-nagios-group=nagios --with-command-group=nagcmd --with-openssl
  args:
    chdir: /root/nagios-plugins-2.2.1
  async: 500
  poll: 10
  when: plugins_downloaded.skipped is not defined and plugins_downloaded.changed

- name: Make nagios-plugins
  make:
    chdir: /root/nagios-plugins-2.2.1
    target: "{{ item }}"
  with_items:
    - all
    - install
  async: 120
  poll: 10
  when: plugins_downloaded.skipped is not defined and plugins_downloaded.changed

#--------------------------------------------------
# CONFIGURATION NRPE
#--------------------------------------------------
- name: set Nagios server IP address in allowed hosts
  lineinfile:
    name: /usr/local/nagios/etc/nrpe.cfg
    regexp: "^allowed_hosts="
    line: allowed_hosts={{ groups.docker_nagios | map('extract', hostvars, ['ansible_ssh_host']) | join(',') }},127.0.0.1
  when: inventory_hostname not in groups.docker_nagios
  notify: restart nrpe
  tags: nrpe_config

- name: set Nagios server IP address in allowed hosts
  lineinfile:
    name: /usr/local/nagios/etc/nrpe.cfg
    regexp: "^allowed_hosts="
    line: allowed_hosts=172.24.0.2,127.0.0.1
  when: inventory_hostname in groups.docker_nagios
  notify: restart nrpe
  tags: nrpe_config

#--------------------------------------------------
# AJOUT CUSTOM SCRIPTs
#--------------------------------------------------
- name: get custom scripts from bitbucket
  git: repo="https://bitbucket.org/chaudlesmarmots/nagios-plugin.git" dest="/usr/local/nagios/libexec/custom-plugin"

- name: set file rights on custom plugins
  file: name={{ item }} mode=0555
  with_items:
    - /usr/local/nagios/libexec/custom-plugin/check_cloud_storage.sh
    - /usr/local/nagios/libexec/custom-plugin/check_fail2ban.sh
    - /usr/local/nagios/libexec/custom-plugin/check_mountpoint.sh
    - /usr/local/nagios/libexec/custom-plugin/check_newest_file_age.sh

- name: add check_docker script
  get_url: 
    url: https://raw.githubusercontent.com/timdaman/check_docker/master/check_docker/check_docker.py
    dest: /usr/local/nagios/libexec/custom-plugin/check_docker.py
    mode: 0555
  when: inventory_hostname in groups.docker

- name: add check_mem.pl script
  get_url:
    url: https://raw.githubusercontent.com/justintime/nagios-plugins/master/check_mem/check_mem.pl
    dest: /usr/local/nagios/libexec/custom-plugin/check_mem.pl
    mode: 0555
 
- name: add nagios to www-data group
  user:
    name: nagios
    groups: www-data
    append: yes
  when: inventory_hostname in groups.owncloud_server | union(groups.docker_owncloud) | union(groups.docker_nextcloud)

- name: add nagios to docker group
  user:
    name: nagios
    groups: docker
    append: yes
  when: inventory_hostname in groups.docker

#--------------------------------------------------
# MODIFICATION NRPE.CFG
#--------------------------------------------------

- name: add custom plugins section in nrpe.cfg
  lineinfile:
    name: /usr/local/nagios/etc/nrpe.cfg
    line: "# Custom Services"
  tags: nrpe_config

# OpenStack cloud storage check
- name: add check cloud storage
  lineinfile:
    name: /usr/local/nagios/etc/nrpe.cfg
    regexp: "check_cloud_storage"
    line: "command[check_cloud_storage]=/usr/local/nagios/libexec/custom-plugin/check_cloud_storage.sh"
  when: inventory_hostname in groups.backup_server
  notify: restart nrpe
  tags: nrpe_config

# Disk usage checks
- name: modify plugin check hda1 in nrpe.cfg for physical servers - new config
  lineinfile:
    name: /usr/local/nagios/etc/nrpe.cfg
    regexp: "check_hda1"
    line: "command[check_hda1]=/usr/local/nagios/libexec/check_disk -w 20% -c 10% -p /"
  notify: restart nrpe
  tags: nrpe_config

- name: modify plugin check vdb in nrpe.cfg for VPS servers - owncloud servers 
  lineinfile:
    name: /usr/local/nagios/etc/nrpe.cfg
    regexp: "check_vdb"
    line: "command[check_vdb]=/usr/local/nagios/libexec/check_disk -w 20% -c 10% -p /var/www/owncloud/data"
  when: inventory_hostname in groups.extradisk_vps and inventory_hostname in groups.owncloud_server
  notify: restart nrpe
  tags: nrpe_config

- name: modify plugin check vdb in nrpe.cfg for VPS servers - other servers
  lineinfile:
    name: /usr/local/nagios/etc/nrpe.cfg
    regexp: "check_vdb"
    line: "command[check_vdb]=/usr/local/nagios/libexec/check_disk -w 15% -c 10% -p /mnt/vdb"
  when: inventory_hostname in groups.extradisk_vps and inventory_hostname not in groups.owncloud_server
  notify: restart nrpe
  tags: nrpe_config

# Docker checks
- name: add check docker odoo on SSD1 server
  lineinfile:
    name: /usr/local/nagios/etc/nrpe.cfg
    regexp: "check_docker_odoo]"
    line: "command[check_docker_odoo]=/usr/local/nagios/libexec/custom-plugin/check_docker.py --container odoo_.* --cpu 10:15 --memory 35:45:% --status running"
  when: inventory_hostname in groups.docker_odoo and inventory_hostname not in groups.docker_owncloud | union(groups.docker_nextcloud)
  notify: restart nrpe
  tags: nrpe_config

- name: add check docker odoo on SSD2/3 servers
  lineinfile:
    name: /usr/local/nagios/etc/nrpe.cfg
    regexp: "check_docker_odoo]"
    line: "command[check_docker_odoo]=/usr/local/nagios/libexec/custom-plugin/check_docker.py --container odoo.* --cpu 10:15 --memory 30:40:% --status running"
  when: inventory_hostname in groups.docker_odoo | intersect(groups.docker_owncloud) or inventory_hostname in groups.docker_odoo | intersect(groups.docker_nextcloud)
  notify: restart nrpe
  tags: nrpe_config

- name: add check docker odoo test
  lineinfile:
    name: /usr/local/nagios/etc/nrpe.cfg
    regexp: "check_docker_odoo_test"
    line: "command[check_docker_odoo_test]=/usr/local/nagios/libexec/custom-plugin/check_docker.py --container testodoo.* --cpu 10:15 --memory 20:25:% --status running"
  when: inventory_hostname in groups.docker_odoo
  notify: restart nrpe
  tags: nrpe_config

- name: add check docker whitelists
  lineinfile:
    name: /usr/local/nagios/etc/nrpe.cfg
    regexp: "check_docker_whitelists"
    line: "command[check_docker_whitelists]=/usr/local/nagios/libexec/custom-plugin/check_docker.py --container whitelists.* --cpu 5:10 --memory 5:7:% --status running"
  when: inventory_hostname in groups.docker | intersect(groups.docker_odoo)
  notify: restart nrpe
  tags: nrpe_config

- name: add check docker owncloud when alone
  lineinfile:
    name: /usr/local/nagios/etc/nrpe.cfg
    regexp: "check_docker_cloud"
    line: "command[check_docker_cloud]=/usr/local/nagios/libexec/custom-plugin/check_docker.py --container owncloud.* --cpu 70:80 --memory 65:85:% --status running"
  when: inventory_hostname not in groups.docker_odoo and inventory_hostname in groups.docker_owncloud
  notify: restart nrpe
  tags: nrpe_config

- name: add check docker nextcloud when alone
  lineinfile:
    name: /usr/local/nagios/etc/nrpe.cfg
    regexp: "check_docker_cloud"
    line: "command[check_docker_cloud]=/usr/local/nagios/libexec/custom-plugin/check_docker.py --container nextcloud.* --cpu 70:80 --memory 65:85:% --status running"
  when: inventory_hostname not in groups.docker_odoo and inventory_hostname in groups.docker_nextcloud
  notify: restart nrpe
  tags: nrpe_config

- name: add check docker owncloud for servers with Odoo as well
  lineinfile:
    name: /usr/local/nagios/etc/nrpe.cfg
    regexp: "check_docker_cloud"
    line: "command[check_docker_cloud]=/usr/local/nagios/libexec/custom-plugin/check_docker.py --container owncloud.* --cpu 70:80 --memory 15:25:% --status running"
  when: inventory_hostname in groups.docker_odoo and inventory_hostname in groups.docker_owncloud
  notify: restart nrpe
  tags: nrpe_config

- name: add check docker nextcloud for servers with Odoo as well
  lineinfile:
    name: /usr/local/nagios/etc/nrpe.cfg
    regexp: "check_docker_cloud"
    line: "command[check_docker_cloud]=/usr/local/nagios/libexec/custom-plugin/check_docker.py --container nextcloud.* --cpu 70:80 --memory 15:25:% --status running"
  when: inventory_hostname in groups.docker_odoo and inventory_hostname in groups.docker_nextcloud
  notify: restart nrpe
  tags: nrpe_config

- name: add check docker proxy
  lineinfile:
    name: /usr/local/nagios/etc/nrpe.cfg
    regexp: "check_docker_proxy"
    line: "command[check_docker_proxy]=/usr/local/nagios/libexec/custom-plugin/check_docker.py --container inverseproxy.* --cpu 10:15 --memory 10:15:% --status running"
  when: inventory_hostname in groups.docker
  notify: restart nrpe
  tags: nrpe_config

- name: add check docker nagios
  lineinfile:
    name: /usr/local/nagios/etc/nrpe.cfg
    regexp: "check_docker_nagios"
    line: "command[check_docker_nagios]=/usr/local/nagios/libexec/custom-plugin/check_docker.py --container nagios.* --cpu 10:15 --memory 10:15:% --status running"
  when: inventory_hostname in groups.docker_nagios
  notify: restart nrpe
  tags: nrpe_config

- name: add check docker ldap
  lineinfile:
    name: /usr/local/nagios/etc/nrpe.cfg
    regexp: "check_docker_ldap"
    line: "command[check_docker_ldap]=/usr/local/nagios/libexec/custom-plugin/check_docker.py --container .*ldap.* --cpu 5:10 --memory 12:17:% --status running"
  when: inventory_hostname in groups.docker_auth
  notify: restart nrpe
  tags: nrpe_config

- name: add check docker sso
  lineinfile:
    name: /usr/local/nagios/etc/nrpe.cfg
    regexp: "check_docker_sso"
    line: "command[check_docker_sso]=/usr/local/nagios/libexec/custom-plugin/check_docker.py --container sso --cpu 5:10 --memory 7:12:% --status running"
  when: inventory_hostname in groups.docker_auth
  notify: restart nrpe
  tags: nrpe_config

# Fail2ban checks
- name: add custom plugin check fail2ban in nrpe.cfg
  lineinfile:
    name: /usr/local/nagios/etc/nrpe.cfg
    regexp: 'check_fail2ban'
    line: "command[check_fail2ban]=/usr/local/nagios/libexec/custom-plugin/check_fail2ban.sh -p /etc/fail2ban/jail.local -l /var/log/fail2ban.log -w 5 -c 10"
  notify: restart nrpe
  tags: nrpe_config

# Load CPU checks
- name: Modify check load in nrpe.cfg 
  lineinfile:
    name: /usr/local/nagios/etc/nrpe.cfg
    regexp: "check_load -r -w"
    line: "command[check_load]=/usr/local/nagios/libexec/check_load -r -w .35,.30,.25 -c .55,.50,.45"
  notify: restart nrpe
  when: inventory_hostname not in groups.bluemind_server|union(groups.log_server)
  tags: nrpe_config

- name: Modify check load for Log Server in nrpe.cfg 
  lineinfile:
    name: /usr/local/nagios/etc/nrpe.cfg
    regexp: "check_load -r -w"
    line: "command[check_load]=/usr/local/nagios/libexec/check_load -r -w .85,.80,.75 -c .99,.95,.90"
  notify: restart nrpe
  when: inventory_hostname in groups.log_server
  tags: nrpe_config

- name: Modify check load for Mail Server in nrpe.cfg 
  lineinfile:
    name: /usr/local/nagios/etc/nrpe.cfg
    regexp: "check_load -r -w"
    line: "command[check_load]=/usr/local/nagios/libexec/check_load -r -w .85,.80,.75 -c .99,.95,.90"
  notify: restart nrpe
  when: inventory_hostname in groups.bluemind_server
  tags: nrpe_config

# Memory RAM usage check
- name: add custom plugin check_mem in nrpe.cfg
  lineinfile:
    name: /usr/local/nagios/etc/nrpe.cfg
    regexp: 'check_mem'
    line: "command[check_mem]=/usr/local/nagios/libexec/custom-plugin/check_mem.pl -f -C -w 20 -c 5"
  notify: restart nrpe
  tags: nrpe_config

# NFS mountpoints check
- name: add plugin check mountpoints to verify that Docker Odoo backup dir is not mounted
  lineinfile:
    name: /usr/local/nagios/etc/nrpe.cfg
    regexp: "check_mountpoint"
    line: "command[check_mountpoint]=/usr/local/nagios/libexec/custom-plugin/check_mountpoint.sh -I /home/docker/backups/odoo"
  when: inventory_hostname in groups.maintenance_nfs | intersect(groups.docker_odoo)
  notify: restart nrpe
  tags: nrpe_config

- name: add plugin check mountpoints to verify that non-Docker Odoo backup dir is mounted
  lineinfile:
    name: /usr/local/nagios/etc/nrpe.cfg
    regexp: "check_mountpoint"
    line: "command[check_mountpoint]=/usr/local/nagios/libexec/custom-plugin/check_mountpoint.sh /mnt/backup-odoo"
  when: inventory_hostname in groups.maintenance_nfs | intersect(groups.odoo_server)
  notify: restart nrpe
  tags: nrpe_config

# Backup server Odoo backups check
- name: Check Odoo backups file age
  lineinfile:
    name: /usr/local/nagios/etc/nrpe.cfg
    regexp: "check_newest_file_age"
    line: "command[check_newest_file_age]=/usr/local/nagios/libexec/custom-plugin/check_newest_file_age.sh -V --base-dir /mnt/vdb/backup/ -d '{{ groups.maintenance_nfs | intersect(groups.odoo_server | union(groups.docker_odoo)) | join(' ') | lower }} sftp/{{ groups.maintenance_sftp | join(' /sftp/') | lower }}'"
  when: inventory_hostname in groups.backup_server
  notify: restart nrpe
  tags: nrpe_config

# Running processes checks
- name: add check processs nginx
  lineinfile:
    name: /usr/local/nagios/etc/nrpe.cfg
    regexp: "check_procs_nginx"
    line: "command[check_procs_nginx]=/usr/local/nagios/libexec/check_procs -w 5 -c 2: -C nginx"
  when: inventory_hostname not in groups.bluemind_server|union(groups.log_server)
  notify: restart nrpe
  tags: nrpe_config

- name: add check processs nginx
  lineinfile:
    name: /usr/local/nagios/etc/nrpe.cfg
    regexp: "check_procs_nginx"
    line: "command[check_procs_nginx]=/usr/local/nagios/libexec/check_procs -w 13 -c 2: -C httpd"
  when: inventory_hostname in groups.log_server
  notify: restart nrpe
  tags: nrpe_config

- name: add check processs nginx
  lineinfile:
    name: /usr/local/nagios/etc/nrpe.cfg
    regexp: "check_procs_nginx"
    line: "command[check_procs_nginx]=/usr/local/nagios/libexec/check_procs -w 13 -c 2: -C nginx"
  when: inventory_hostname in groups.bluemind_server
  notify: restart nrpe
  tags: nrpe_config

- name: add check processs odoo
  lineinfile:
    name: /usr/local/nagios/etc/nrpe.cfg
    regexp: "check_procs_odoo"
    line: "command[check_procs_odoo]=/usr/local/nagios/libexec/check_procs -w 2 -c 1: -C python -a odoo-bin"
  when: inventory_hostname in groups.odoo_server
  notify: restart nrpe
  tags: nrpe_config

- name: add check process owncloud
  lineinfile:
    name: /usr/local/nagios/etc/nrpe.cfg
    regexp: "check_procs_owncloud"
    line: "command[check_procs_owncloud]=/usr/local/nagios/libexec/check_procs -w 10 -c 2: -C php-fpm7.0"
  when: inventory_hostname in groups.owncloud_server
  notify: restart nrpe
  tags: nrpe_config

- name: modify procs number in nrpe.cfg for bluemind, and server with both odoo and owncloud
  lineinfile:
    name: /usr/local/nagios/etc/nrpe.cfg
    regexp: "check_total_procs"
    line: command[check_total_procs]=/usr/local/nagios/libexec/check_procs -w 225 -c 250
  when: inventory_hostname in groups.bluemind_server | union(groups.owncloud_server) | union(groups.odoo_server)
  notify: restart nrpe
  tags: nrpe_config

- name: modify procs number in nrpe.cfg for servers with odoo docker only
  lineinfile:
    name: /usr/local/nagios/etc/nrpe.cfg
    regexp: "check_total_procs"
    line: command[check_total_procs]=/usr/local/nagios/libexec/check_procs -w 230 -c 250
  when: inventory_hostname in groups.docker_odoo and inventory_hostname not in groups.docker_owncloud and inventory_hostname not in groups.docker_nextcloud
  notify: restart nrpe
  tags: nrpe_config

- name: modify procs number in nrpe.cfg for servers with cloud docker only
  lineinfile:
    name: /usr/local/nagios/etc/nrpe.cfg
    regexp: "check_total_procs"
    line: command[check_total_procs]=/usr/local/nagios/libexec/check_procs -w 210 -c 230
  when: inventory_hostname not in groups.docker_odoo and inventory_hostname in groups.docker_owncloud | union(groups.docker_nextcloud)
  notify: restart nrpe
  tags: nrpe_config

- name: modify procs number in nrpe.cfg for servers with odoo and cloud dockers but no auth docker
  lineinfile:
    name: /usr/local/nagios/etc/nrpe.cfg
    regexp: "check_total_procs"
    line: command[check_total_procs]=/usr/local/nagios/libexec/check_procs -w 275 -c 300
  when: inventory_hostname in groups.docker_odoo | intersect(groups.docker_owncloud | union(groups.docker_nextcloud)) and inventory_hostname not in groups.docker_auth
  notify: restart nrpe
  tags: nrpe_config
    
- name: modify procs number in nrpe.cfg for servers with odoo, cloud and auth dockers but nagios
  lineinfile:
    name: /usr/local/nagios/etc/nrpe.cfg
    regexp: "check_total_procs"
    line: command[check_total_procs]=/usr/local/nagios/libexec/check_procs -w 320 -c 350
  when: inventory_hostname in groups.docker_odoo | intersect(groups.docker_owncloud | union(groups.docker_nextcloud)) | intersect(groups.docker_auth) and inventory_hostname not in groups.docker_nagios
  notify: restart nrpe
  tags: nrpe_config

- name: modify procs number in nrpe.cfg for servers with odoo, cloud, nagios and auth dockers
  lineinfile:
    name: /usr/local/nagios/etc/nrpe.cfg
    regexp: "check_total_procs"
    line: command[check_total_procs]=/usr/local/nagios/libexec/check_procs -w 450 -c 480
  when: inventory_hostname in groups.docker_odoo | intersect(groups.docker_owncloud | union(groups.docker_nextcloud)) | intersect(groups.docker_auth) | intersect(groups.docker_nagios)
  notify: restart nrpe
  tags: nrpe_config

- name: add check processs sshd
  lineinfile:
    name: /usr/local/nagios/etc/nrpe.cfg
    regexp: "check_procs_sshd"
    line: "command[check_procs_sshd]=/usr/local/nagios/libexec/check_procs -w 2 -c 1: -C sshd -a -D"
  notify: restart nrpe
  tags: nrpe_config
